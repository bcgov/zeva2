FROM artifacts.developer.gov.bc.ca/docker-remote/node:22.13.1

RUN apt-get update && apt-get install -y bash

WORKDIR /next

COPY . .

RUN npm install

RUN npx prisma generate && npx prisma generate --schema prisma/schemaOld.prisma

RUN npm run build

EXPOSE 3000

CMD ["/bin/sh", "-c", "\
  for cfg in database minio redis; do \
    if [ -f /vault/secrets/$cfg ]; then \
      . /vault/secrets/$cfg; \
    fi; \
  done; \
  npm run pushAndSeed && npm run start\
"]