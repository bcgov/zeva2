generator client {
  provider        = "prisma-client-js"
  output          = "./generated/client"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// prisma doesn't allow enum values to start with a number
enum ModelYear {
  MY_2019 @map("2019")
  MY_2020 @map("2020")
  MY_2021 @map("2021")
  MY_2022 @map("2022")
  MY_2023 @map("2023")
  MY_2024 @map("2024")
  MY_2025 @map("2025")
  MY_2026 @map("2026")
  MY_2027 @map("2027")
  MY_2028 @map("2028")
  MY_2029 @map("2029")
  MY_2030 @map("2030")
  MY_2031 @map("2031")
  MY_2032 @map("2032")
  MY_2033 @map("2033")
  MY_2034 @map("2034")
  MY_2035 @map("2035")
}

model Organization {
  id                    Int                       @id @default(autoincrement())
  name                  String
  isGovernment          Boolean                   @default(false) @map("is_government")
  isActive              Boolean                   @default(true) @map("is_active")
  shortName             String?                   @map("short_name")
  firstModelYear        ModelYear?                @map("first_model_year")
  users                 User[]
  zevUnitTransactions   ZevUnitTransaction[]
  zevUnitEndingBalances ZevUnitEndingBalance[]
  zevUnitTransferTo     ZevUnitTransfer[]         @relation("zevUnitTransferTo")
  zevUnitTransferFrom   ZevUnitTransfer[]         @relation("zevUnitTransferFrom")
  Vehicle               Vehicle[]
  VehicleChangeHistory  VehicleChangeHistory[]
  organizationAddress   OrganizationAddress[]
  ldvSupplied           OrganizationLDVSupplied[]
  CreditApplication     CreditApplication[]
  PenaltyCredit         PenaltyCredit[]
  agreements            Agreement[]

  @@map("organization")
}

model OrganizationAddress {
  id             Int          @id @default(autoincrement())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId Int          @map("organization_id")
  addressType    AddressType  @map("address_type")
  expirationDate DateTime?    @map("expiration_date")
  addressLines   String?      @map("address_lines")
  city           String?
  postalCode     String?      @map("postal_code")
  state          String?
  county         String?
  country        String?
  representative String?

  @@index([organizationId, addressType, expirationDate], map: "organization_address_organization_type_expiration")
  @@map("organization_address")
}

model OrganizationLDVSupplied {
  id             Int          @id @default(autoincrement())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId Int          @map("organization_id")
  volume         Int
  modelYear      ModelYear    @map("model_year")

  @@index([organizationId, modelYear], map: "organization_id_model_year")
  @@map("organization_ldv_supplied")
}

enum AddressType {
  RECORDS
  SERVICE
}

enum Role {
  ADMINISTRATOR              @map("Administrator")
  DIRECTOR                   @map("Director")
  ENGINEER_ANALYST           @map("Engineer/Analyst")
  ORGANIZATION_ADMINISTRATOR @map("Organization Administrator")
  SIGNING_AUTHORITY          @map("Signing Authority")
  ZEVA_USER                  @map("ZEVA User")
}

enum Idp {
  AZURE_IDIR     @map("azureidir")
  BCEID_BUSINESS @map("bceidbusiness")
}

enum Notification {
  MODEL_YEAR_REPORT_RETURNED_TO_SUPPLIER
  ZEV_MODEL_SUBMITTED
  ZEV_MODEL_RANGE_REPORT_SUBMITTED
  CREDIT_TRANSFER_APPROVED
  CREDIT_APPLICATION_SUBMITTED
  CREDIT_APPLICATION_CHECKED
  CREDIT_APPLICATION_ISSUED_GOVT
  CREDIT_TRANSFER_RECORDED_GOVT
  CREDIT_TRANSFER_REJECTED_GOVT
  CREDIT_TRANSFER_RECOMMEND_APPROVAL
  CREDIT_TRANSFER_RECOMMEND_REJECT
  CREDIT_APPLICATION_RECOMMEND_APPROVAL
  CREDIT_TRANSFER_APPROVED_PARTNER
  ZEV_MODEL_VALIDATED
  ZEV_MODEL_REJECTED
  CREDIT_TRANSFER_RECORDED
  CREDIT_TRANSFER_REJECTED
  CREDIT_APPLICATION_ISSUED
  CREDIT_TRANSFER_SUBMITTED
  CREDIT_TRANSFER_RESCINDED_PARTNER
  CREDIT_TRANSFER_REJECTED_PARTNER
  ZEV_MODEL_RANGE_REPORT_TEST_RESULT_REQUESTED
  CREDIT_TRANSFER_RESCINDED
}

model User {
  id                     Int                      @id @default(autoincrement())
  contactEmail           String?                  @map("contact_email")
  idpSub                 String?                  @map("idp_sub")
  idp                    Idp                      @map("idp")
  idpUsername            String                   @map("idp_username")
  isActive               Boolean                  @default(true) @map("is_active")
  organization           Organization             @relation(fields: [organizationId], references: [id])
  organizationId         Int                      @map("organization_id")
  roles                  Role[]
  zevUnitTransferHistory ZevUnitTransferHistory[]
  notifications          Notification[]
  firstName              String                   @map("first_name")
  lastName               String                   @map("last_name")
  wasUpdated             Boolean                  @default(false) @map("was_updated")

  vehicleCommentsCreated   VehicleComment[]           @relation("user that created comment")
  vehicleCommentsUpdated   VehicleComment[]           @relation("user that updated comment")
  vehicleStatusChanged     VehicleChangeHistory[]     @relation("user that changed the status")
  CreditApplicationHistory CreditApplicationHistory[]
  PenaltyCreditHistory     PenaltyCreditHistory[]
  agreementHistory         AgreementHistory[]

  @@unique([idp, idpUsername])
  @@map("user")
}

enum TransactionType {
  CREDIT
  DEBIT
  TRANSFER_AWAY
}

enum ReferenceType {
  TRANSFER
  PENALTY_CREDITS
  OBLIGATION_REDUCTION
  ASSESSMENT_ADJUSTMENT
  SUPPLY_CREDITS
  AGREEMENT
}

enum ZevClass {
  A
  B
  C
  UNSPECIFIED
}

enum VehicleClass {
  REPORTABLE
}

model ZevUnitTransaction {
  id                Int             @id @default(autoincrement())
  organization      Organization    @relation(fields: [organizationId], references: [id])
  organizationId    Int             @map("organization_id")
  type              TransactionType
  referenceType     ReferenceType   @map("reference_type")
  referenceId       Int?            @map("reference_id")
  legacyReferenceId Int?            @map("legacy_reference_id")
  numberOfUnits     Decimal         @map("number_of_units") @db.Decimal(65, 2)
  zevClass          ZevClass        @map("zev_class")
  vehicleClass      VehicleClass    @map("vehicle_class")
  modelYear         ModelYear       @map("model_year")
  timestamp         DateTime        @default(now()) @db.Timestamptz(6)

  @@map("zev_unit_transaction")
}

enum BalanceType {
  CREDIT
  DEBIT
}

model ZevUnitEndingBalance {
  id                   Int          @id @default(autoincrement())
  organization         Organization @relation(fields: [organizationId], references: [id])
  organizationId       Int          @map("organization_id")
  complianceYear       ModelYear    @map("compliance_year")
  type                 BalanceType
  initialNumberOfUnits Decimal      @map("initial_number_of_units") @db.Decimal(65, 2)
  finalNumberOfUnits   Decimal      @map("final_number_of_units") @db.Decimal(65, 2)
  zevClass             ZevClass     @map("zev_class")
  vehicleClass         VehicleClass @map("vehicle_class")
  modelYear            ModelYear    @map("model_year")

  @@unique([organizationId, complianceYear, zevClass, vehicleClass, modelYear])
  @@map("zev_unit_ending_balance")
}

enum ZevUnitTransferStatuses {
  DRAFT
  SUBMITTED_TO_TRANSFER_TO
  RESCINDED_BY_TRANSFER_FROM
  APPROVED_BY_TRANSFER_TO
  REJECTED_BY_TRANSFER_TO
  RECOMMEND_APPROVAL_GOV
  RECOMMEND_REJECTION_GOV
  RETURNED_TO_ANALYST
  APPROVED_BY_GOV
  REJECTED_BY_GOV
  DELETED
}

model ZevUnitTransfer {
  id                     Int                      @id @default(autoincrement())
  transferToId           Int                      @map("transfer_to_id")
  transferTo             Organization             @relation("zevUnitTransferTo", fields: [transferToId], references: [id])
  transferFromId         Int                      @map("transfer_from_id")
  transferFrom           Organization             @relation("zevUnitTransferFrom", fields: [transferFromId], references: [id])
  status                 ZevUnitTransferStatuses
  zevUnitTransferContent ZevUnitTransferContent[]
  zevUnitTransferHistory ZevUnitTransferHistory[]

  @@map("zev_unit_transfer")
}

model ZevUnitTransferContent {
  id                 Int             @id @default(autoincrement())
  zevUnitTransferId  Int             @map("zev_unit_transfer_id")
  zevUnitTransfer    ZevUnitTransfer @relation(fields: [zevUnitTransferId], references: [id])
  numberOfUnits      Decimal         @map("number_of_units") @db.Decimal(65, 2)
  zevClass           ZevClass        @map("zev_class")
  vehicleClass       VehicleClass    @map("vehicle_class")
  modelYear          ModelYear       @map("model_year")
  dollarValuePerUnit Decimal         @map("dollar_value_per_unit") @db.Decimal(65, 2)

  @@map("zev_unit_transfer_content")
}

enum ZevUnitTransferHistoryUserActions {
  SUBMITTED_TO_TRANSFER_TO
  RESCINDED_BY_TRANSFER_FROM
  APPROVED_BY_TRANSFER_TO
  REJECTED_BY_TRANSFER_TO
  RECOMMEND_APPROVAL_GOV
  RECOMMEND_REJECTION_GOV
  RETURNED_TO_ANALYST
  APPROVED_BY_GOV
  REJECTED_BY_GOV
  ADDED_COMMENT_GOV_INTERNAL
}

model ZevUnitTransferHistory {
  id                Int                               @id @default(autoincrement())
  zevUnitTransferId Int                               @map("zev_unit_transfer_id")
  zevUnitTransfer   ZevUnitTransfer                   @relation(fields: [zevUnitTransferId], references: [id])
  userId            Int                               @map("user_id")
  user              User                              @relation(fields: [userId], references: [id])
  timestamp         DateTime                          @default(now()) @db.Timestamptz(6)
  userAction        ZevUnitTransferHistoryUserActions @map("user_action")
  comment           String?

  @@map("zev_unit_transfer_history")
}

enum VehicleZevType {
  BEV
  PHEV
  EREV
  FCEV
}

enum VehicleClassCode {
  T
  I
  S
  C
  M
  L
  WS
  WM
  PS
  PL
  US
  UL
  V
  VC
  VP
  SP
}

enum VehicleStatus {
  CHANGES_REQUESTED
  DELETED
  DRAFT
  REJECTED
  SUBMITTED
  VALIDATED
}

model Vehicle {
  id                   Int                    @id @default(autoincrement())
  range                Int
  make                 String
  modelYear            ModelYear              @map("model_year")
  status               VehicleStatus
  modelName            String                 @map("model_name")
  creditValue          Decimal?               @map("credit_value") @db.Decimal(65, 2)
  vehicleZevType       VehicleZevType         @map("vehicle_zev_type")
  vehicleClassCode     VehicleClassCode       @map("vehicle_class_code")
  weightKg             Decimal                @map("weight_kg") @db.Decimal(6, 0)
  organization         Organization           @relation(fields: [organizationId], references: [id])
  organizationId       Int                    @map("organization_id")
  vehicleClass         VehicleClass?          @map("vehicle_class")
  zevClass             ZevClass?              @map("credit_class")
  hasPassedUs06Test    Boolean                @map("has_passed_us_06_test")
  isActive             Boolean                @map("is_active")
  VehicleChangeHistory VehicleChangeHistory[]
  VehicleComment       VehicleComment[]
  VehicleAttachment    VehicleAttachment[]
  CreditApplicationVin CreditApplicationVin[]

  @@map("vehicle")
}

model VehicleChangeHistory {
  id               Int              @id @default(autoincrement())
  createTimestamp  DateTime?        @default(now()) @map("create_timestamp") @db.Timestamptz(6)
  vehicleClassCode VehicleClassCode @map("vehicle_class_code")
  createUserId     Int              @map("create_user_id")
  createUser       User             @relation("user that changed the status", fields: [createUserId], references: [id])
  vehicleZevType   VehicleZevType   @map("vehicle_zev_type")
  range            Int
  make             String?          @map("make")
  weightKg         Decimal          @map("weight_kg")
  modelName        String?          @map("model_name")
  modelYear        ModelYear        @map("model_year")
  organization     Organization     @relation(fields: [organizationId], references: [id])
  organizationId   Int              @map("organization_id")
  validationStatus String?          @map("validation_status")
  vehicle          Vehicle          @relation(fields: [vehicleId], references: [id])
  vehicleId        Int              @map("vehicle_id")
  userRole         String[]         @map("user_role")

  @@map("vehicle_change_history")
}

model VehicleComment {
  id              Int       @id @default(autoincrement())
  createTimestamp DateTime? @default(now()) @map("create_timestamp") @db.Timestamptz(6)
  createUserId    Int       @map("create_user_id")
  createUser      User      @relation("user that created comment", fields: [createUserId], references: [id])
  updateTimestamp DateTime? @updatedAt @map("update_timestamp") @db.Timestamptz(6)
  updateUserId    Int?      @map("update_user_id")
  updateUser      User?     @relation("user that updated comment", fields: [updateUserId], references: [id])
  vehicleId       Int       @map("vehicle_id")
  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  comment         String    @map("vehicle_comment")

  @@map("vehicle_comment")
}

model VehicleAttachment {
  id              Int       @id @default(autoincrement())
  createTimestamp DateTime? @default(now()) @map("create_timestamp") @db.Timestamptz(6)
  updateTimestamp DateTime? @updatedAt @map("update_timestamp") @db.Timestamptz(6)
  vehicleId       Int       @map("vehicle_id")
  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  filename        String    @db.VarChar(260)
  minioObjectName String    @map("minio_object_name")
  size            BigInt    @default(0)
  mimeType        String?   @map("mime_type")
  isRemoved       Boolean   @default(false) @map("is_removed")
  createUser      String    @map("create_user") @db.VarChar(130)
  updateUser      String?   @map("update_user") @db.VarChar(130)

  @@map("vehicle_file_attachment")
}

enum IcbcFileStatus {
  FAILURE
  PROCESSING
  SUCCESS
}

model IcbcFile {
  id                            Int            @id @default(autoincrement())
  isLegacy                      Boolean        @default(false) @map("is_legacy")
  name                          String         @unique
  status                        IcbcFileStatus
  timestamp                     DateTime       @db.Timestamptz(6)
  numberOfRecordsPreProcessing  Int?           @map("number_of_records_pre_processing")
  numberOfRecordsPostProcessing Int?           @map("number_of_records_post_processing")
  icbcRecords                   IcbcRecord[]

  @@map("icbc_file")
}

model IcbcRecord {
  id         Int       @id @default(autoincrement())
  icbcFileId Int       @map("icbc_file_id")
  icbcFile   IcbcFile  @relation(fields: [icbcFileId], references: [id])
  vin        String    @unique @db.VarChar(17)
  make       String
  model      String
  year       ModelYear

  @@map("icbc_record")
}

enum CreditApplicationStatus {
  APPROVED
  RECOMMEND_APPROVAL
  RECOMMEND_REJECTION
  REJECTED
  RETURNED_TO_ANALYST
  RETURNED_TO_SUPPLIER
  SUBMITTED
}

enum CreditApplicationSupplierStatus {
  APPROVED
  REJECTED
  RETURNED_TO_SUPPLIER
  SUBMITTED
}

model CreditApplication {
  id                       Int                             @id @default(autoincrement())
  organization             Organization                    @relation(fields: [organizationId], references: [id])
  organizationId           Int                             @map("organization_id")
  submissionTimestamp      DateTime                        @default(now()) @map("submission_timestamp") @db.Timestamptz(6)
  status                   CreditApplicationStatus         @map("status")
  supplierStatus           CreditApplicationSupplierStatus @map("supplier_status")
  supplierFileId           String                          @map("supplier_file_id")
  supplierFileName         String                          @map("supplier_file_name")
  CreditApplicationHistory CreditApplicationHistory[]
  CreditApplicationRecord  CreditApplicationRecord[]
  CreditApplicationVin     CreditApplicationVin[]

  @@map("credit_application")
}

model CreditApplicationHistory {
  id                  Int                     @id @default(autoincrement())
  creditApplicationId Int                     @map("credit_application_id")
  creditApplication   CreditApplication       @relation(fields: [creditApplicationId], references: [id])
  userId              Int                     @map("user_id")
  user                User                    @relation(fields: [userId], references: [id])
  timestamp           DateTime                @default(now()) @db.Timestamptz(6)
  userAction          CreditApplicationStatus @map("user_action")
  comment             String?

  @@map("credit_application_history")
}

model CreditApplicationRecord {
  id                  Int               @id @default(autoincrement())
  creditApplicationId Int               @map("credit_application_id")
  creditApplication   CreditApplication @relation(fields: [creditApplicationId], references: [id])
  vin                 String            @db.VarChar(17)
  timestamp           DateTime          @db.Timestamptz(6)
  vehicleClass        VehicleClass?     @map("vehicle_class")
  zevClass            ZevClass?         @map("zev_class")
  modelYear           ModelYear         @map("model_year")
  numberOfUnits       Decimal?          @map("number_of_units") @db.Decimal(65, 2)
  make                String
  modelName           String            @map("model_name")
  icbcMake            String?           @map("icbc_make")
  icbcModelName       String?           @map("icbc_model_name")
  icbcModelYear       ModelYear?        @map("icbc_model_year")
  icbcTimestamp       DateTime?         @map("icbc_timestamp") @db.Timestamptz(6)
  validated           Boolean
  reason              String?
  warnings            String[]

  @@map("credit_application_record")
}

model CreditApplicationVin {
  id                  Int               @id @default(autoincrement())
  creditApplicationId Int               @map("credit_application_id")
  creditApplication   CreditApplication @relation(fields: [creditApplicationId], references: [id])
  vin                 String            @unique @db.VarChar(17)
  vehicleId           Int               @map("vehicle_id")
  vehicle             Vehicle           @relation(fields: [vehicleId], references: [id])
  timestamp           DateTime          @db.Timestamptz(6)

  @@map("credit_application_vin")
}

model CreditApplicationVinLegacy {
  id  Int    @id @default(autoincrement())
  vin String @unique @db.VarChar(17)

  @@map("credit_application_vin_legacy")
}

enum PenaltyCreditStatus {
  APPROVED
  REJECTED
  SUBMITTED_TO_DIRECTOR
}

model PenaltyCredit {
  id                   Int                    @id @default(autoincrement())
  organization         Organization           @relation(fields: [organizationId], references: [id])
  organizationId       Int                    @map("organization_id")
  complianceYear       ModelYear              @map("compliance_year")
  status               PenaltyCreditStatus
  vehicleClass         VehicleClass           @map("vehicle_class")
  zevClass             ZevClass               @map("zev_class")
  modelYear            ModelYear              @map("model_year")
  numberOfUnits        Decimal                @map("number_of_units") @db.Decimal(65, 2)
  PenaltyCreditHistory PenaltyCreditHistory[]

  @@map("penalty_credit")
}

model PenaltyCreditHistory {
  id              Int                 @id @default(autoincrement())
  penaltyCredit   PenaltyCredit       @relation(fields: [penaltyCreditId], references: [id])
  penaltyCreditId Int                 @map("penalty_credit_id")
  userId          Int                 @map("user_id")
  user            User                @relation(fields: [userId], references: [id])
  timestamp       DateTime            @default(now()) @db.Timestamptz(6)
  userAction      PenaltyCreditStatus @map("user_action")
  comment         String?

  @@map("penalty_credit_history")
}

enum AgreementType {
  INITIATIVE
  PURCHASE
}

enum AgreementStatus {
  DRAFT
  RECOMMEND_APPROVAL
  RETURNED_TO_ANALYST
  ISSUED
  DELETED
}

enum AgreementUserAction {
  SAVED
  RECOMMEND_APPROVAL
  RETURNED_TO_ANALYST
  ISSUED
  DELETED
  ADDED_COMMENT_GOV_INTERNAL
}

model Agreement {
  id               Int                @id @default(autoincrement())
  optionalId       String?            @map("optional_id")
  organization     Organization       @relation(fields: [organizationId], references: [id])
  organizationId   Int                @map("organization_id")
  agreementType    AgreementType      @map("agreement_type")
  status           AgreementStatus
  effectiveDate    DateTime?          @map("effective_date")
  comment          String?
  agreementContent AgreementContent[]
  agreementHistory AgreementHistory[]

  @@map("agreement")
}

model AgreementContent {
  id            Int       @id @default(autoincrement())
  agreement     Agreement @relation(fields: [agreementId], references: [id])
  agreementId   Int       @map("agreement_id")
  zevClass      ZevClass  @map("zev_class")
  modelYear     ModelYear @map("model_year")
  numberOfUnits Decimal   @map("number_of_units") @db.Decimal(65, 2)

  @@map("agreement_content")
}

model AgreementHistory {
  id          Int             @id @default(autoincrement())
  agreementId Int             @map("agreement_id")
  agreement   Agreement       @relation(fields: [agreementId], references: [id])
  userId      Int             @map("user_id")
  user        User            @relation(fields: [userId], references: [id])
  timestamp   DateTime        @default(now()) @db.Timestamptz(6)
  userAction  AgreementStatus @map("user_action")
  comment     String?

  @@map("agreement_history")
}
