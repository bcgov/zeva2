name: PR CI (Next.js + Prisma + Postgres 17)

on:
  pull_request:
    branches: ["**"]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    # PostgreSQL 17 service container
    services:
      postgres:
        image: postgres:17
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ci
        options: >-
          --health-cmd="pg_isready -U postgres -d ci"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20

    env:
      # Prisma connection string to the Postgres service
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/ci?schema=public
      # If Next.js tests need NODE_ENV production behavior, adjust as needed:
      NODE_ENV: test

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: ğŸ“¦ Enable Corepack & Install
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          pnpm --version
          # Install dependencies for the Next.js app under ./next
          cd next
          pnpm install --frozen-lockfile

      - name: ğŸ—ƒï¸ Generate Prisma Client
        working-directory: next
        run: pnpm prisma generate

      - name: ğŸ› ï¸ Prepare Test DB schema
        working-directory: next
        run: |
          # If you have migrations, prefer migrate deploy; otherwise db push is fine.
          pnpm prisma migrate deploy || pnpm prisma db push

      # (Optional) If your tests rely on seeded data, uncomment:
      # - name: ğŸŒ± Seed database
      #   working-directory: next
      #   run: pnpm prisma db seed

      - name: âœ… Run tests (in ./next)
        working-directory: next
        run: pnpm test -- --ci
